worker_processes auto;

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;

        # Frontend origin
        set $frontend_origin 'http://localhost:3000';

        # ------------------------
        # AUTH SERVICE (PUBLIC)
        # ------------------------
        location /api/v1/auth/ {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $frontend_origin;
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Content-Type';
                add_header 'Content-Length' 0;
                return 204;
            }

            proxy_pass http://auth-service:3000/api/v1/auth/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;

            add_header 'Access-Control-Allow-Origin' $frontend_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
        }

        # ------------------------
        # INTERNAL AUTH VERIFY
        # ------------------------
        location = /_auth_verify {
            internal;

            proxy_pass http://auth-service:3000/api/v1/auth/verify;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;

            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
        }

        # ------------------------
        # USER SERVICE (PROTECTED)
        # ------------------------
        location /api/v1/profile {

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $frontend_origin;
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Content-Type';
                add_header 'Content-Length' 0;
                return 204;
            }

            # üîê Cookie-based auth check
            auth_request /_auth_verify;

            error_page 401 = @unauthorized;
            error_page 403 = @unauthorized;

            proxy_pass http://user-service:3001/api/v1/profile;
            proxy_http_version 1.1;

            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_email $upstream_http_x_user_email;

            proxy_set_header X-User-Id $user_id;
            proxy_set_header X-User-Email $user_email;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;

            add_header 'Access-Control-Allow-Origin' $frontend_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
        }

        location /ws {

            proxy_pass http://websocket-service:8080/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
        }

        location /api/v1/project {

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $frontend_origin;
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Content-Type';
                add_header 'Content-Length' 0;
                return 204;
            }

            # üîê Cookie-based auth check
            auth_request /_auth_verify;

            error_page 401 = @unauthorized;
            error_page 403 = @unauthorized;

            proxy_pass http://project-service:3005/api/v1/project;
            proxy_http_version 1.1;

            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_email $upstream_http_x_user_email;

            proxy_set_header X-User-Id $user_id;
            proxy_set_header X-User-Email $user_email;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;

            add_header 'Access-Control-Allow-Origin' $frontend_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
        }


        # ------------------------
        # UNAUTHORIZED HANDLER
        # ------------------------
        location @unauthorized {
            add_header 'Access-Control-Allow-Origin' $frontend_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            return 401;
        }


    }
}
